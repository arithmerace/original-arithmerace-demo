(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{172:function(e,t,n){var content=n(202);"string"==typeof content&&(content=[[e.i,content,""]]),content.locals&&(e.exports=content.locals);(0,n(40).default)("1ec96180",content,!0,{sourceMap:!1})},201:function(e,t,n){"use strict";var o=n(172);n.n(o).a},202:function(e,t,n){(e.exports=n(39)(!1)).push([e.i,'#game[data-v-510f5b41]{padding:10px;width:720px;margin:auto;border:1px solid grey;border-radius:4px}#ui[data-v-510f5b41]{height:100px;width:700px}.ui-value[data-v-510f5b41]{font-size:2em;text-align:center}.ui-label[data-v-510f5b41]{text-align:center;color:grey}.fuel-full[data-v-510f5b41]{color:green}.fuel-medium[data-v-510f5b41]{color:orange}.fuel-low[data-v-510f5b41]{color:red}#player-labels[data-v-510f5b41]{position:relative;float:left;height:450px;background-color:green}.speech-bubble[data-v-510f5b41]{position:absolute;right:5px;border-radius:.4em;margin-right:2px}.bubble-default[data-v-510f5b41]{background:#676088}.bubble-player[data-v-510f5b41]{background:#c7c400}.speech-bubble h1[data-v-510f5b41]{color:#fff;margin:5px}.speech-bubble[data-v-510f5b41]:after{content:"";position:absolute;right:0;top:50%;width:0;height:0;border:5px solid transparent;border-left-color:#676088;border-right:0;margin-top:-5px;margin-right:-5px}',""])},212:function(e,t,n){"use strict";n.r(t);n(187),n(73),n(29),n(56);var o=n(38),r=(n(188),n(30),n(42),n(74),n(75),n(16),n(11)),l=null;l=n(209);var c={name:"Race",components:{},data:function(){return{app:null,user:null,raceRef:null,serverTimeOffset:null,config:{batteryLifeSpan:5,batteryProgressPerSecond:1,canvasHeight:450,canvasWidth:700,forceCanvas:!0,canvasBackgroundColor:16777215,numTracks:5,trackHeight:80,stripeWidth:35,stripeHeight:5,stripeColor:16711680,stripeMovementRate:10,playerAnimationSpeed:.2},game:{running:!1,finished:!1,position:"-",numBatteries:0,waitingRoomText:null,questionValue:"",questionLabel:"In waiting room",userSolution:"",solutionInputDisabled:!0,solutionFieldType:null,finishSubmitted:!1,track:{stripes:[]},players:{}}}},mounted:function(){var e=this;Object(r.b)().onAuthStateChanged(function(t){t?(e.user=t,e.joinWaitingRoom()):Object(r.b)().signInAnonymously().then(function(t){e.user=t,e.joinWaitingRoom()}).catch(function(t){return e.$disp_error("signInAnon: "+t,e)})})},beforeDestroy:function(){var e=this.raceRef?this.raceRef.key:null;this.submitExitRace({raceId:e}),this.app.destroy(!1,!0)},methods:{submitSolution:Object(r.d)().httpsCallable("submitProblemSolution"),submitFinish:Object(r.d)().httpsCallable("submitFinish"),submitExitRace:Object(r.d)().httpsCallable("exitRace"),joinWaitingRoom:function(){var e=this;this.app=new l.Application({width:this.config.canvasWidth,height:this.config.canvasHeight,view:this.$refs.raceCanvas,backgroundColor:this.config.canvasBackgroundColor,forceCanvas:this.config.forceCanvas}),this.game.waitingRoomText=new l.Text("Joining Waiting Room"),this.game.waitingRoomText.position.set(200,300),this.app.stage.addChild(this.game.waitingRoomText);var t=Object(r.c)().ref("waitingroom/"+this.user.uid);t.set({waiting:!0}).catch(function(t){return e.$disp_error("waitingroomset:"+t,e)}),t.onDisconnect().remove();var n=Object(r.c)().ref("waitingroom");n.on("value",function(t){var text="0 players";null!==t.val()&&(text=Object.keys(t.val()).length.toString()+" player(s)"),e.game.waitingRoomText.text=text+" in waiting room",e.game.questionValue=text}),Object(r.c)().ref("user/"+this.user.uid+"/assignedRace").on("value",function(t){null!=t.val()&&(e.raceRef=Object(r.c)().ref("race/"+t.val()),n.off(),e.initRace())})},initRace:function(){var e=this;this.$toast.open({message:"Race starting soon",queue:!1}),document.title="RACE STARTING SOON",this.game.questionLabel="Problem:",this.game.questionValue="wait...",this.raceRef.child("player").once("value",function(t){e.game.waitingRoomText.text="";for(var n=function(){var t=Object(o.a)(d[c],2),n=t[0],r=t[1];e.game.players[n]={lane:r.lane,name:r.name,robot:r.robot,batteries:{},numBatteries:0,progress:0,finished:!1},e.app.loader.add({url:"/robotassets/"+r.robot+"/spritesheet.json",name:"robot"+n},function(){var t=e.app.loader.resources["robot"+n].spritesheet,o=new l.AnimatedSprite(t.animations[r.robot]);o.animationSpeed=e.config.playerAnimationSpeed,o.y=(r.lane-1)*(e.config.trackHeight+e.config.stripeHeight),e.game.players[n].sprite=o,e.app.stage.addChild(e.game.players[n].sprite)})},c=0,d=Object.entries(t.val());c<d.length;c++)n();for(var h=e.config.canvasWidth/e.config.stripeWidth/2,f=1;f<=e.config.numTracks;f++)for(var m=0;m<h;m++){var v=2*e.config.stripeWidth*m,y=(e.config.trackHeight+e.config.stripeHeight)*f-e.config.stripeHeight,x=(new l.Graphics).beginFill(e.config.stripeColor).drawRect(0,0,e.config.stripeWidth,e.config.stripeHeight).endFill();x.position.set(v,y),e.game.track.stripes.push(x),e.app.stage.addChild(e.game.track.stripes[e.game.track.stripes.length-1])}e.app.loader.load(),e.app.ticker.add(function(t){return e.main(t)}),Object(r.c)().ref(".info/serverTimeOffset").on("value",function(t){e.serverTimeOffset=t.val()}),e.raceRef.child("firstProblem").on("value",function(t){t.val()&&e.startRace(t.val())})})},startRace:function(e){var t=this;document.title="Arithmerace",this.$toast.open({message:"Race starting!",queue:!1}),this.game.questionValue=e,this.game.solutionInputDisabled=!1,this.$refs.solutionInput.focus();for(var n=function(){var e=Object(o.a)(l[r],2),n=e[0],c=e[1];t.raceRef.child("player/"+n).on("value",function(e){return t.updatePlayer(e,n)}),c.sprite.play()},r=0,l=Object.entries(this.game.players);r<l.length;r++)n();this.game.running=!0},main:function(e){if(this.game.running){this.update();var t=!0,n=!1,o=void 0;try{for(var r,l=this.game.track.stripes[Symbol.iterator]();!(t=(r=l.next()).done);t=!0){var c=r.value;c.x-=this.config.stripeMovementRate+e,c.x<=-this.config.stripeWidth&&(c.x=this.config.canvasWidth-(-this.config.stripeWidth-c.x))}}catch(e){n=!0,o=e}finally{try{t||null==l.return||l.return()}finally{if(n)throw o}}for(var d=0,h=Object.values(this.game.players);d<h.length;d++){var f=h[d];f.sprite&&(f.sprite.x=Math.floor(f.progress*((this.config.canvasWidth-f.sprite.width)/100)))}}},update:function(){for(var e=0,t=Object.values(this.game.players);e<t.length;e++){var n=t[e];if(!n.finished){for(var progress=0,r=0,l=0,c=Object.values(n.batteries);l<c.length;l++){var d=c[l],h=(Date.now()+this.serverTimeOffset-d.used)/1e3;h>this.config.batteryLifeSpan?progress+=this.config.batteryProgressPerSecond*this.config.batteryLifeSpan:(progress+=this.config.batteryProgressPerSecond*h,r+=1)}n.progress=progress,n.numBatteries=r}}var f=Object.entries(this.game.players).sort(function(a,b){return b[1].progress-a[1].progress});console.log(f);for(var m={},v=0,y=Object.entries(f);v<y.length;v++){var x=Object(o.a)(y[v],2),R=x[0];m[x[1][0]]=parseInt(R)+1}console.log(m),this.game.numBatteries=this.game.players[this.user.uid].numBatteries+1,this.game.position=this.$with_ordinal_suffix(m[this.user.uid]),this.game.players[this.user.uid].progress>=100&&this.handleFinishRace()},updatePlayer:function(e,t){this.game.players[t].batteries=e.val().batteries,this.game.players[t].finished=e.val().finished,e.val().finished&&(this.game.players[t].progress=100)},handleSolution:function(){var e=this;this.game.solutionInputDisabled=!0,this.submitSolution({solution:this.game.userSolution,raceId:this.raceRef.key}).then(function(t){t.data.correct?(e.game.questionValue=t.data.nextProblem,e.game.solutionFieldType="is-success",setTimeout(function(){e.game.userSolution="",e.game.solutionInputDisabled=!1,e.$refs.solutionInput.focus(),e.game.solutionFieldType=null},500)):(e.game.solutionFieldType="is-danger",e.$toast.open({type:"is-danger",message:"Try again!",duration:1e3,position:"is-bottom-right",queue:!1}),setTimeout(function(){e.game.userSolution="",e.game.solutionInputDisabled=!1,e.$refs.solutionInput.focus(),e.game.solutionFieldType=null},500))}).catch(function(t){return e.$disp_error("submitSolution:"+t.message,e)})},handleFinishRace:function(){var e=this;this.game.finishSubmitted||(this.submitFinish({raceId:this.raceRef.key}).then(function(t){if(t.data.success){e.$toast.open({message:"You finished the race ".concat(e.$with_ordinal_suffix(t.data.finalPosition)," and earned ").concat(t.data.coinsAwarded," Arithmecoins."),duration:8e3,type:"is-success"}),e.game.players[e.user.uid].finished=!0,e.game.solutionInputDisabled=!0,e.game.questionLabel="Finished",e.game.questionValue=e.$with_ordinal_suffix(t.data.finalPosition),e.game.finished=!0;for(var n=0,o=Object.values(e.game.players);n<o.length;n++){o[n].sprite.stop()}}else e.$toast.open("ERROR: due to an internal error, you were unable to finish the race.")}).catch(function(t){return e.$disp_error("You were unable to finish the race, due to an error: submitFinish: "+t,e)}),this.game.finishSubmitted=!0,this.game.running=!1)}}},d=(n(201),n(6)),h={name:"RacePage",components:{Race:Object(d.a)(c,function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("div",{attrs:{id:"game"}},[n("div",{attrs:{id:"player-labels"}},e._l(e.game.players,function(t,o){return n("div",{key:o,staticClass:"speech-bubble",class:{"bubble-default":o!==e.user.uid,"bubble-player":o===e.user.uid},style:"top: "+(t.lane-1)*(e.config.trackHeight+e.config.stripeHeight)+"px;"},[n("h1",[e._v("\n          "+e._s(t.name)+"\n        ")])])}),0),e._v(" "),n("div",{attrs:{id:"canvas-div"}},[n("canvas",{ref:"raceCanvas",attrs:{width:e.config.canvasWidth,height:e.config.canvasHeight}})]),e._v(" "),n("div",{staticClass:"columns",attrs:{id:"ui"}},[n("div",{staticClass:"columns column"},[n("div",{staticClass:"column"},[n("div",{staticClass:"ui-label"},[e._v("\n            Batteries\n          ")]),e._v(" "),n("div",{staticClass:"ui-value",class:{"fuel-full":e.game.numBatteries>=4,"fuel-medium":e.game.numBatteries>=2&&e.game.numBatteries<4,"fuel-low":e.game.numBatteries<2}},[e._v("\n            "+e._s(e.game.numBatteries)+"\n          ")])])]),e._v(" "),n("div",{staticClass:"column"},[n("div",{staticClass:"ui-label"},[e._v("\n          "+e._s(e.game.questionLabel)+"\n        ")]),e._v(" "),n("div",{staticClass:"ui-value"},[e._v("\n          "+e._s(e.game.questionValue)+"\n        ")])]),e._v(" "),n("div",{staticClass:"column",on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSolution(t)}}},[n("div",{staticClass:"ui-label"},[e._v("\n          Your solution\n        ")]),e._v(" "),n("b-field",{attrs:{type:e.game.solutionFieldType}},[n("b-input",{ref:"solutionInput",attrs:{placeholder:"Enter a number",type:"number",disabled:e.game.solutionInputDisabled},model:{value:e.game.userSolution,callback:function(t){e.$set(e.game,"userSolution",t)},expression:"game.userSolution"}}),e._v(" "),n("b-button",{attrs:{disabled:e.game.solutionInputDisabled,type:"is-primary"},on:{click:e.handleSolution}},[n("b-icon",{attrs:{icon:"arrow-right"}})],1)],1)],1),e._v(" "),n("div",{staticClass:"columns column"},[n("div",{staticClass:"column"},[n("div",{staticClass:"ui-label"},[e._v("\n            Position\n          ")]),e._v(" "),n("div",{staticClass:"ui-value"},[e._v("\n            "+e._s(e.game.position)+"\n          ")])])])])])])},[],!1,null,"510f5b41",null).exports}},f=Object(d.a)(h,function(){var e=this.$createElement,t=this._self._c||e;return t("section",{staticClass:"section"},[t("no-ssr",{attrs:{placeholder:"Loading..."}},[t("Race")],1)],1)},[],!1,null,null,null);t.default=f.exports}}]);